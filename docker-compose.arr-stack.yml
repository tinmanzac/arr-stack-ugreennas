version: "3.8"

#########################
# Centralized Volumes   #
#########################
volumes:
  qbittorrent-config:
  sonarr-config:
  prowlarr-config:
  radarr-config:
  jellyfin-config:
  jellyfin-cache:
  pihole-etc-pihole:
  pihole-etc-dnsmasq:
  wireguard-easy-config:

#########################
# Networks              #
#########################
networks:
  vpn-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.8.1.0/24
  traefik-proxy:
    external: true

#########################
# Logging               #
#########################
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

#########################
# Services              #
#########################
services:
  #############################################
  # VPN Health Monitor (deunhealth)          #
  #############################################
  deunhealth:
    image: qmcgaw/deunhealth
    container_name: deunhealth
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ:-Europe/London}
    restart: unless-stopped
    logging: *default-logging

  #############################################
  # VPN Gateway (Gluetun with Surfshark)    #
  #############################################
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    env_file:
      - .env
    volumes:
      - /volume1/docker/arr-stack/gluetun-config:/gluetun
    environment:
      # VPN Configuration - see .env.example for provider-specific setup
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER:-surfshark}
      - VPN_TYPE=${VPN_TYPE:-wireguard}
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - SERVER_COUNTRIES=${VPN_COUNTRIES:-United Kingdom}
      - TZ=${TZ:-Europe/London}
      - DNS_ADDRESS=192.168.100.5
      - FIREWALL_OUTBOUND_SUBNETS=192.168.0.0/24,192.168.100.0/24,10.8.1.0/24
    ports:
      # Ports for services using network_mode: "service:gluetun"
      # Enables direct local access without Traefik (http://NAS_IP:PORT)
      - "8989:8989"   # Sonarr
      - "7878:7878"   # Radarr
      - "9696:9696"   # Prowlarr
      - "8085:8085"   # qBittorrent
    networks:
      traefik-proxy:
        ipv4_address: 192.168.100.3
      vpn-net:
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s  # Give VPN time to establish connection

  #############################################
  # Download Client (qBittorrent via VPN)    #
  #############################################
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent
    container_name: qbittorrent
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-Europe/London}
      - WEBUI_PORT=8085
      - DOCKER_MODS=ghcr.io/vuetorrent/vuetorrent-lsio-mod:latest
    volumes:
      - qbittorrent-config:/config
      - /volume1/Media/downloads:/downloads
      - /volume1/Media:/media
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/"]
      interval: 1m30s
      timeout: 10s
      retries: 3

  #############################################
  # TV Show Management (Sonarr via VPN)      #
  #############################################
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-Europe/London}
    volumes:
      - sonarr-config:/config
      - /volume1/Media/tv:/tv
      - /volume1/Media/downloads:/downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/"]
      interval: 2m
      timeout: 10s
      retries: 3

  #############################################
  # Indexer Manager (Prowlarr via VPN)       #
  #############################################
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-Europe/London}
    volumes:
      - prowlarr-config:/config
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/"]
      interval: 2m
      timeout: 10s
      retries: 3

  #############################################
  # Movie Management (Radarr via VPN)        #
  #############################################
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-Europe/London}
    volumes:
      - radarr-config:/config
      - /volume1/Media/movies:/movies
      - /volume1/Media/downloads:/downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/"]
      interval: 2m
      timeout: 10s
      retries: 3

  #############################################
  # Media Server (Jellyfin)                  #
  #############################################
  jellyfin:
    image: jellyfin/jellyfin
    container_name: jellyfin
    ports:
      - "8096:8096"  # Local network access (all interfaces)
    environment:
      - TZ=${TZ:-Europe/London}
    volumes:
      - jellyfin-config:/config
      - jellyfin-cache:/cache
      - /volume1/Media/movies:/media/movies:ro
      - /volume1/Media/tv:/media/tv:ro
    networks:
      traefik-proxy:
        ipv4_address: 192.168.100.4
    labels:
      # Routing handled by traefik/dynamic/vpn-services.yml (not Docker labels)
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-proxy"
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 3m
      timeout: 10s
      retries: 2

  #############################################
  # DNS & Ad-blocking (Pi-hole)              #
  #############################################
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    ports:
      - "${NAS_IP:-0.0.0.0}:53:53/tcp"  # Bind to NAS IP to avoid conflict with localhost dnsmasq
      - "${NAS_IP:-0.0.0.0}:53:53/udp"
    networks:
      traefik-proxy:
        ipv4_address: 192.168.100.5
      vpn-net:
        ipv4_address: 10.8.1.200
    environment:
      - TZ=${TZ:-Europe/London}
      - FTLCONF_webserver_api_password=${PIHOLE_UI_PASS}
      - FTLCONF_dns_listeningMode=all
    volumes:
      - pihole-etc-pihole:/etc/pihole
      - pihole-etc-dnsmasq:/etc/dnsmasq.d
    labels:
      # Routing handled by traefik/dynamic/vpn-services.yml (not Docker labels)
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-proxy"
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - SYS_TIME
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "-p", "53", "google.com", "+short"]
      interval: 5m
      timeout: 10s
      retries: 2

  #############################################
  # WireGuard VPN Server (wg-easy)           #
  #############################################
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy
    container_name: wg-easy
    environment:
      - LANG=en
      - WG_HOST=wg.${DOMAIN}
      - PASSWORD_HASH=${WG_PASSWORD_HASH}
      - WG_DEFAULT_ADDRESS=10.8.0.x
      - WG_DEFAULT_DNS=10.8.1.200
      - TZ=${TZ:-Europe/London}
    volumes:
      - wireguard-easy-config:/etc/wireguard
    labels:
      # Routing handled by traefik/dynamic/vpn-services.yml (not Docker labels)
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-proxy"
    ports:
      - "51820:51820/udp"
    networks:
        traefik-proxy:
          ipv4_address: 192.168.100.6
        vpn-net:
          ipv4_address: 10.8.1.3
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "wg", "show"]
      interval: 5m
      timeout: 10s
      retries: 1

  #############################################
  # Request Manager (Jellyseerr)             #
  #############################################
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    ports:
      - "5055:5055"  # Local network access (all interfaces)
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ:-Europe/London}
      - PORT=5055
    networks:
      traefik-proxy:
        ipv4_address: 192.168.100.8
    labels:
      # Routing handled by traefik/dynamic/vpn-services.yml (not Docker labels)
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-proxy"
    volumes:
      - /volume1/docker/arr-stack/jellyseerr/config:/app/config
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 2m
      timeout: 10s
      retries: 3

  #############################################
  # Subtitle Management (Bazarr)             #
  #############################################
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    ports:
      - "6767:6767"  # Local network access
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-Europe/London}
    networks:
      traefik-proxy:
        ipv4_address: 192.168.100.9
    volumes:
      - /volume1/docker/arr-stack/bazarr/config:/config
      - /volume1/Media/movies:/movies
      - /volume1/Media/tv:/tv
    labels:
      # Routing handled by traefik/dynamic/vpn-services.yml (not Docker labels)
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-proxy"
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/"]
      interval: 3m
      timeout: 10s
      retries: 2

  #############################################
  # Cloudflare Bypass (FlareSolverr)         #
  #############################################
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ:-Europe/London}
    networks:
      traefik-proxy:
        ipv4_address: 192.168.100.10
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8191/"]
      interval: 3m
      timeout: 10s
      retries: 2

  #############################################
  # Monitoring (Uptime Kuma)                 #
  #############################################
  uptime-kuma:
    image: louislam/uptime-kuma:2
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "3001:3001"  # Local network access
    environment:
      - TZ=${TZ:-Europe/London}
    networks:
      traefik-proxy:
        ipv4_address: 192.168.100.13
    volumes:
      - /volume1/docker/arr-stack/uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For Docker container monitoring
    labels:
      # Routing handled by traefik/dynamic/vpn-services.yml (not Docker labels)
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-proxy"
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "node /app/extra/healthcheck.js"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

# ═══════════════════════════════════════════════════════════════════════════════
# CLOUDFLARE TUNNEL - Secure remote access without port forwarding (Anywhere setup)
#
# What it does:
# - Creates an encrypted tunnel from your NAS to Cloudflare's network
# - Routes jellyfin.yourdomain.com → your Jellyfin through the tunnel
# - No ports exposed on your router = more secure
#
# You DON'T need this if you're only accessing services locally.
# Requires: Cloudflare account (free), domain pointed to Cloudflare.
#
# No web UI - runs silently in background.
#
# NOTE: Uses separate project name so compose operations on other files
# don't accidentally stop the tunnel (was causing Error 1033).
# ═══════════════════════════════════════════════════════════════════════════════

name: cloudflared

services:
  cloudflared:
    image: cloudflare/cloudflared:2026.2.0
    container_name: cloudflared
    command: tunnel --config /home/nonroot/.cloudflared/config.yml run
    volumes:
      - ./cloudflared:/home/nonroot/.cloudflared:ro
    networks:
      arr-stack:
        ipv4_address: 172.20.0.12
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info", "nas-tunnel"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "deunhealth.restart.on.unhealthy=true"
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  arr-stack:
    external: true

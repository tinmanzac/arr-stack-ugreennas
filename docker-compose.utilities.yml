
#########################
# Optional NAS Utilities #
#########################
# These services are useful but not required for the media stack.
# Deploy with: docker compose -f docker-compose.utilities.yml up -d

#########################
# Volumes               #
#########################
volumes:
  duc-index:
  uptime-kuma-data:
  beszel-data:
  diun-data:

#########################
# Networks              #
#########################
networks:
  arr-stack:
    external: true

#########################
# Logging               #
#########################
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

#########################
# Services              #
#########################
services:
  # ═══════════════════════════════════════════════════════════════════════════
  # DEUNHEALTH - Auto-recovery for VPN failures. Watches gluetun health and
  # restarts dependent services (qBittorrent, Sonarr, etc.) when VPN recovers.
  # No web UI. Runs silently in background.
  # ═══════════════════════════════════════════════════════════════════════════
  deunhealth:
    image: qmcgaw/deunhealth:v0.3.0
    container_name: deunhealth
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=${TZ}
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "/app", "healthcheck"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ═══════════════════════════════════════════════════════════════════════════
  # UPTIME KUMA - Monitoring dashboard. Shows health of all your services.
  # Access: uptime.lan | NAS_IP:3001 (LAN-only, use WireGuard for remote)
  # ═══════════════════════════════════════════════════════════════════════════
  uptime-kuma:
    image: louislam/uptime-kuma:2
    container_name: uptime-kuma
    restart: always
    ports:
      - "3001:3001"  # Local network access only
    environment:
      - TZ=${TZ}
    networks:
      arr-stack:
        ipv4_address: 172.20.0.13  # For monitoring other containers
    volumes:
      - uptime-kuma-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For Docker container monitoring
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "node /app/extra/healthcheck.js"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════════════
  # DUC - Disk usage analyzer. Visual treemap UI showing what's using storage.
  # Access: duc.lan | NAS_IP:8838 (LAN-only, use WireGuard for remote)
  # Note: Re-indexes daily at 4am. Manual: docker restart duc
  # ═══════════════════════════════════════════════════════════════════════════
  duc:
    image: mkoestler/duc-service:v1.1.0
    container_name: duc
    networks:
      arr-stack:
        ipv4_address: 172.20.0.14
    volumes:
      - /volume1:/scan/volume1:ro      # NAS data (read-only)
      - duc-index:/database            # Persistent index
    ports:
      - "8838:80"                      # Local network access only
    environment:
      - TZ=${TZ}
      - SCHEDULE=0 4 * * *             # Re-index daily at 4am
    restart: always
    logging: *default-logging

  # ═══════════════════════════════════════════════════════════════════════════
  # QBIT-SCHEDULER - Pauses torrents overnight to let disks spin down.
  # Default: pause at 20:00, resume at 06:00. No web UI.
  # ═══════════════════════════════════════════════════════════════════════════
  qbit-scheduler:
    build: ./scripts/qbit-scheduler
    container_name: qbit-scheduler
    environment:
      - TZ=${TZ}
      - QBIT_HOST=${NAS_IP}
      - QBIT_PORT=8085
      - QBIT_USER=${QBIT_USER}
      - QBIT_PASS=${QBIT_PASSWORD}
      - PAUSE_HOUR=${QBIT_PAUSE_HOUR}
      - RESUME_HOUR=${QBIT_RESUME_HOUR}
    restart: always
    logging: *default-logging

  # ═══════════════════════════════════════════════════════════════════════════
  # BESZEL - Lightweight server monitoring with historical data and alerts.
  # Access: beszel.lan | NAS_IP:8090 (LAN-only, use WireGuard for remote)
  # ═══════════════════════════════════════════════════════════════════════════
  beszel:
    image: henrygd/beszel:0.18
    container_name: beszel
    restart: always
    ports:
      - "8090:8090"
    networks:
      arr-stack:
        ipv4_address: 172.20.0.15
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - beszel-data:/beszel_data
    environment:
      - TZ=${TZ}
    logging: *default-logging
    healthcheck:
      test: ["CMD", "/beszel", "health", "--url", "http://localhost:8090"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  beszel-agent:
    image: henrygd/beszel-agent:0.18
    container_name: beszel-agent
    restart: always
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - PORT=45876
      - KEY=${BESZEL_KEY}
    logging: *default-logging
    healthcheck:
      test: ["CMD", "/agent", "health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ═══════════════════════════════════════════════════════════════════════════
  # DIUN - Docker Image Update Notifier. Watches running containers and sends
  # webhook notifications when newer image versions are available on registries.
  # No web UI. Configure DIUN_WEBHOOK_URL in .env to receive alerts.
  # ═══════════════════════════════════════════════════════════════════════════
  diun:
    image: crazymax/diun:v4.31.0
    container_name: diun
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - diun-data:/data
    networks:
      arr-stack:
        ipv4_address: 172.20.0.16
    environment:
      - TZ=${TZ}
      - DIUN_WATCH_WORKERS=5
      - DIUN_WATCH_SCHEDULE=${DIUN_SCHEDULE:-0 6 * * *}
      - DIUN_PROVIDERS_DOCKER=true
      - DIUN_PROVIDERS_DOCKER_WATCHBYDEFAULT=true
      - DIUN_NOTIF_WEBHOOK_ENDPOINT=${DIUN_WEBHOOK_URL}
      - DIUN_NOTIF_WEBHOOK_METHOD=POST
      - DIUN_NOTIF_WEBHOOK_HEADERS_0_NAME=Content-Type
      - DIUN_NOTIF_WEBHOOK_HEADERS_0_VALUE=application/json
    logging: *default-logging

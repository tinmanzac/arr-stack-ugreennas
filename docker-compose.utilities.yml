
#########################
# Optional NAS Utilities #
#########################
# These services are useful but not required for the media stack.
# Deploy with: docker compose -f docker-compose.utilities.yml up -d

#########################
# Volumes               #
#########################
volumes:
  duc-index:

#########################
# Networks              #
#########################
networks:
  traefik-proxy:
    external: true

#########################
# Logging               #
#########################
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

#########################
# Services              #
#########################
services:
  #############################################
  # VPN Health Monitor (deunhealth)          #
  #############################################
  # Monitors gluetun and restarts dependent containers when VPN recovers.
  # Works across compose files via Docker socket.
  deunhealth:
    image: qmcgaw/deunhealth
    container_name: deunhealth
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ:-Europe/London}
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD", "/app", "healthcheck"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

  #############################################
  # Monitoring (Uptime Kuma)                 #
  #############################################
  # Local-only access: http://NAS_IP:3001
  # Remote access: Connect via WireGuard VPN first
  uptime-kuma:
    image: louislam/uptime-kuma:2
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "3001:3001"  # Local network access only
    environment:
      - TZ=${TZ:-Europe/London}
    networks:
      traefik-proxy:
        ipv4_address: 192.168.100.13  # For monitoring other containers
    volumes:
      - /volume1/docker/arr-stack/uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For Docker container monitoring
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "node /app/extra/healthcheck.js"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  #############################################
  # Disk Usage Analyzer (duc)                #
  #############################################
  # Visual disk usage analyzer with treemap UI (like DaisyDisk).
  # Re-indexes daily at 4am. Manual re-index: docker restart duc
  #
  # SECURITY: No authentication - local-only access
  # Local access: http://NAS_IP:8838
  # Remote access: Connect via WireGuard VPN first
  duc:
    image: mkoestler/duc-service:latest
    container_name: duc
    volumes:
      - /volume1:/scan/volume1:ro      # NAS data (read-only)
      - duc-index:/database            # Persistent index
    ports:
      - "8838:80"                      # Local network access only
    environment:
      - TZ=${TZ:-Europe/London}
      - SCHEDULE=0 4 * * *             # Re-index daily at 4am
    restart: unless-stopped
    logging: *default-logging

  #############################################
  # qBittorrent Scheduler                     #
  #############################################
  # Pauses all torrents at 20:00, resumes at 06:00
  # Allows NAS disks to spin down overnight
  qbit-scheduler:
    build: ./scripts/qbit-scheduler
    container_name: qbit-scheduler
    environment:
      - TZ=${TZ:-Europe/London}
      - QBIT_HOST=${NAS_IP:-192.168.1.100}
      - QBIT_PORT=8085
      - QBIT_USER=${QBIT_USER:-admin}
      - QBIT_PASS=${QBIT_PASSWORD}
    restart: unless-stopped
    logging: *default-logging

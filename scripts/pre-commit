#!/bin/bash
# Pre-commit hook for arr-stack-ugreennas
# Validates commits for security and consistency
#
# Installation: ./setup-hooks.sh
# Manual test:  ./scripts/pre-commit

set -e

# Get script directory (resolving symlinks) and repo root
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo "$SCRIPT_DIR/..")"

# Color output (disabled if not interactive)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' NC=''
fi

# Source common library first (caches NAS config for all checks)
source "$SCRIPT_DIR/lib/common.sh"

# Source helper functions
source "$SCRIPT_DIR/lib/check-secrets.sh"
source "$SCRIPT_DIR/lib/check-env-vars.sh"
source "$SCRIPT_DIR/lib/check-yaml-syntax.sh"
source "$SCRIPT_DIR/lib/check-conflicts.sh"
source "$SCRIPT_DIR/lib/check-compose-drift.sh"
source "$SCRIPT_DIR/lib/check-hardcoded-domain.sh"
source "$SCRIPT_DIR/lib/check-env-backup.sh"
source "$SCRIPT_DIR/lib/check-uptime-monitors.sh"
source "$SCRIPT_DIR/lib/check-dns-duplicates.sh"
source "$SCRIPT_DIR/lib/check-domains.sh"
source "$SCRIPT_DIR/lib/check-image-versions.sh"

# Track results
ERRORS=0
WARNINGS=0

echo ""
echo -e "${BLUE}Pre-commit validation${NC}"
echo "=========================================="
echo ""

# Check if there are staged changes
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)
if [[ -z "$STAGED_FILES" ]]; then
    echo "No files staged for commit."
    echo ""
    exit 0
fi

# ==========================================
# CHECK 1: Secret Detection (BLOCKS)
# ==========================================
echo -e "${BLUE}1. Checking for secrets...${NC}"
if check_secrets; then
    echo -e "    ${GREEN}OK${NC}: No secrets detected"
else
    ((ERRORS++))
fi
echo ""

# ==========================================
# CHECK 2: Environment Variable Coverage (BLOCKS)
# ==========================================
echo -e "${BLUE}2. Checking environment variable documentation...${NC}"
if check_env_vars; then
    echo -e "    ${GREEN}OK${NC}: All compose variables documented"
fi
# Note: check_env_vars outputs its own errors
if [[ $? -ne 0 ]]; then
    ((ERRORS++))
fi
echo ""

# ==========================================
# CHECK 3: YAML Syntax (BLOCKS)
# ==========================================
echo -e "${BLUE}3. Checking YAML syntax...${NC}"
if check_yaml_syntax; then
    echo -e "    ${GREEN}OK${NC}: YAML syntax valid"
else
    ((ERRORS++))
fi
echo ""

# ==========================================
# CHECK 4: Port/IP Conflicts (BLOCKS)
# ==========================================
echo -e "${BLUE}4. Checking for port/IP conflicts...${NC}"
if check_conflicts; then
    echo -e "    ${GREEN}OK${NC}: No conflicts detected"
else
    ((ERRORS++))
fi
echo ""

# ==========================================
# CHECK 5: Compose Drift (WARNS)
# ==========================================
echo -e "${BLUE}5. Checking Jellyfin/Plex consistency...${NC}"
check_compose_drift
echo ""

# ==========================================
# CHECK 6: Hardcoded Domain (WARNS)
# ==========================================
echo -e "${BLUE}6. Checking for hardcoded domain...${NC}"
check_hardcoded_domain
echo ""

# ==========================================
# CHECK 7: NAS .env Backup Sync (WARNS)
# ==========================================
echo -e "${BLUE}7. Checking .env.nas.backup sync...${NC}"
check_env_backup
echo ""

# ==========================================
# CHECK 8: Uptime Kuma Monitors (WARNS)
# ==========================================
echo -e "${BLUE}8. Checking Uptime Kuma monitors...${NC}"
check_uptime_monitors
echo ""

# ==========================================
# CHECK 9: DNS Duplicates (WARNS)
# ==========================================
echo -e "${BLUE}9. Checking for duplicate .lan domains...${NC}"
check_dns_duplicates
echo ""

# ==========================================
# CHECK 10: Domain Accessibility (WARNS)
# ==========================================
echo -e "${BLUE}10. Checking domain accessibility...${NC}"
check_domains
echo ""

# ==========================================
# CHECK 11: Image Version Staleness (WARNS)
# ==========================================
echo -e "${BLUE}11. Checking for image updates...${NC}"
# Timeout after 30s to prevent slow registries from blocking commits
_timeout_cmd=""
command -v timeout &>/dev/null && _timeout_cmd="timeout"
command -v gtimeout &>/dev/null && _timeout_cmd="gtimeout"
if [[ -n "$_timeout_cmd" ]]; then
    $_timeout_cmd 30 bash -c "source '$SCRIPT_DIR/lib/common.sh'; source '$SCRIPT_DIR/lib/check-image-versions.sh'; check_image_versions" 2>/dev/null || {
        [[ $? -eq 124 ]] && echo "    SKIP: Registry checks timed out (30s)"
    }
else
    check_image_versions
fi
echo ""

# ==========================================
# SUMMARY
# ==========================================
echo "=========================================="
if [[ $ERRORS -gt 0 ]]; then
    echo -e "${RED}BLOCKED${NC}: $ERRORS error(s) found"
    echo ""
    echo "Commit aborted. Fix the errors above and try again."
    echo ""
    echo "To skip hooks (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
else
    echo -e "${GREEN}PASSED${NC}: All checks passed"
    echo ""
    exit 0
fi
